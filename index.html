<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quantum Roulette Elite V5.4 - Master IA</title>
    
    <!-- Bibliotecas Core via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body { 
            background-color: #030305; 
            color: #f4f4f5; 
            font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; 
            margin: 0; 
            overflow-x: hidden; 
            -webkit-tap-highlight-color: transparent; 
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }
        
        .glass {
            background: rgba(15, 15, 20, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .btn-active:active { transform: scale(0.92); transition: 0.1s; }
        .loading-ring { width: 50px; height: 50px; border: 4px solid #10b98120; border-top-color: #10b981; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Token de Número Uniforme - TAMANHO FIXO PARA TODO O LADO */
        .token {
            width: 3.75rem; height: 3.75rem;
            min-width: 3.75rem; min-height: 3.75rem;
            display: flex; align-items: center; justify-content: center;
            border-radius: 1rem; font-weight: 900; font-size: 1.5rem;
            border: 2px solid rgba(255, 255, 255, 0.05); flex-shrink: 0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (max-width: 640px) {
            .token {
                width: 3rem; height: 3rem;
                min-width: 3rem; min-height: 3rem;
                font-size: 1.1rem;
                border-radius: 0.75rem;
            }
        }
        
        .pulse-soft { animation: pulse-soft 2s infinite; }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        // --- CONFIGURAÇÃO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCUcHQrnU-2312pAFiPzH_35SO3gQ6Wsd4",
            authDomain: "meubotroleta.firebaseapp.com",
            projectId: "meubotroleta",
            storageBucket: "meubotroleta.firebasestorage.app",
            messagingSenderId: "22051928464",
            appId: "1:22051928464:web:b58b2604a9b677942adb15",
            measurementId: "G-L5KJFRFJFB"
        };

        const appId = 'roulette-pro-v5';
        const apiKey = ""; // Gemini API

        const COLORS = {
            red: [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36],
            black: [2, 4, 6, 8, 10, 11, 13, 15, 17, 20, 22, 24, 26, 28, 29, 31, 33, 35]
        };

        const ORDERED_NUMBERS = Array.from({ length: 36 }, (_, i) => i + 1);

        const App = () => {
            const [user, setUser] = useState(null);
            const [history, setHistory] = useState([]);
            const [signal, setSignal] = useState(null);
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [aiFeedback, setAiFeedback] = useState("");
            const [status, setStatus] = useState('conectando');

            const lastProcessedSpin = useRef(null);

            // 1. INICIALIZAÇÃO SEGURA (REGRA 3: Auth First)
            useEffect(() => {
                const init = async () => {
                    try {
                        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                        const auth = firebase.auth();
                        const res = await auth.signInAnonymously();
                        setUser(res.user);
                        setStatus('ready');
                    } catch (e) {
                        console.error("Auth Error:", e);
                        setStatus('error');
                    }
                };
                init();
            }, []);

            // 2. RANKING DE ORDEM (CADEIA DE MARKOV) - ANALISA O SUCESSOR MAIS PROVÁVEL
            const transitionsRanking = useMemo(() => {
                if (history.length < 5) return null;
                const lastNum = history[0]; 
                const counts = {};

                for (let i = 1; i < history.length; i++) {
                    if (history[i] === lastNum) {
                        const successor = history[i - 1]; 
                        counts[successor] = (counts[successor] || 0) + 1;
                    }
                }

                const result = Object.entries(counts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([num, count]) => ({ num: parseInt(num), count }));
                
                return result.length > 0 ? result : null;
            }, [history]);

            // 3. IA AUDITORIA - AGORA É O FILTRO FINAL DE ASSERTIVIDADE
            const triggerAiAnalysis = async (nums, sig) => {
                if (!apiKey) return;
                setIsAiLoading(true);
                setAiFeedback("");
                
                const prompt = `AUDITORIA ESTRATÉGICA: Histórico ${nums.slice(0, 12).join(', ')}. Sinal local: ${sig.type} para números ${sig.numbers.join(', ')}. Valida matematicamente usando Poisson e Bernoulli. Se a probabilidade for baixa, diz 'AGUARDAR'. Responde em PT-PT técnico.`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    const feedback = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    
                    if (feedback.toUpperCase().includes("AGUARDAR") || feedback.toUpperCase().includes("NEGADO")) {
                        setSignal(null); // Aborta sinal se IA desconfiar
                        setAiFeedback("IA recomendou aguardar por maior estabilidade de variância.");
                    } else {
                        setAiFeedback(feedback);
                    }
                } catch (err) {
                    setAiFeedback("IA Offline. Usando Kernel Matemático Local.");
                } finally { setIsAiLoading(false); }
            };

            // 4. MOTOR DE ANÁLISE V5.4 (MULTIFATORIAL)
            const runLogic = useCallback((nums) => {
                if (nums.length < 5) return;
                
                // Evita reprocessar o mesmo número
                if (lastProcessedSpin.current === nums[0]) return;
                lastProcessedSpin.current = nums[0];

                const last5 = nums.slice(0, 5);
                const colors = last5.map(n => COLORS.red.includes(n) ? 'R' : (n === 0 ? 'Z' : 'B'));
                
                let newSignal = null;

                // GATILHO 1: Quebra de Cor Bernoulli (Apenas se houver 4+ seguidos)
                if (colors.slice(0,4).every(c => c === 'R')) {
                    newSignal = { type: "REVERSÃO DE POISSON", numbers: [2, 4, 11, 13, 17, 20, 22, 26, 29], confidence: 92 };
                } else if (colors.slice(0,4).every(c => c === 'B')) {
                    newSignal = { type: "REVERSÃO DE POISSON", numbers: [1, 3, 5, 9, 12, 14, 16, 18, 19], confidence: 92 };
                }

                // GATILHO 2: Sucessão Histórica de Markov
                if (!newSignal && transitionsRanking && transitionsRanking[0].count >= 3) {
                    const topNum = transitionsRanking[0].num;
                    newSignal = { type: "VÍCIO DE SUCESSÃO", numbers: [topNum, ...ORDERED_NUMBERS.filter(n => Math.abs(n-topNum) <= 1)].slice(0, 6), confidence: 88 };
                }

                // GATILHO 3: Dúzia Atrasada (Poisson Delay)
                if (!newSignal) {
                    const last12 = nums.slice(0, 12);
                    const d1 = !last12.some(n => n >= 1 && n <= 12);
                    const d2 = !last12.some(n => n >= 13 && n <= 24);
                    const d3 = !last12.some(n => n >= 25 && n <= 36);
                    if (d1) newSignal = { type: "CLUSTER DÚZIA 1", numbers: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], confidence: 94 };
                    else if (d2) newSignal = { type: "CLUSTER DÚZIA 2", numbers: [13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24], confidence: 94 };
                    else if (d3) newSignal = { type: "CLUSTER DÚZIA 3", numbers: [25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36], confidence: 94 };
                }

                if (newSignal) {
                    setSignal(newSignal);
                    triggerAiAnalysis(nums, newSignal);
                } else {
                    setSignal(null);
                    setAiFeedback("");
                }
            }, [transitionsRanking]);

            // 5. FIRESTORE SYNC (REGRA 1 e 2: Caminho Estrito & JS Memory Sorting)
            useEffect(() => {
                if (!user || status !== 'ready') return;
                const db = firebase.firestore();
                // REGRA 1: Caminho absoluto para evitar erros de permissão
                const spinsRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('spins');

                const unsubscribe = spinsRef.onSnapshot((snap) => {
                    const data = snap.docs
                        .map(d => ({ ...d.data() }))
                        // REGRA 2: Ordenação 100% em memória no cliente
                        .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0))
                        .map(d => parseInt(d.number))
                        .filter(n => !isNaN(n));
                    
                    setHistory(data);
                    runLogic(data);
                }, (err) => {
                    console.error("Firestore Error:", err);
                });
                
                return () => unsubscribe();
            }, [user, status, runLogic]);

            const addNumber = async (n) => {
                if (!user || status !== 'ready') return;
                try {
                    const db = firebase.firestore();
                    const spinsRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('spins');
                    await spinsRef.add({
                        number: parseInt(n),
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (e) { 
                    console.error("Falha na gravação:", e); 
                }
            };

            const getStyle = (n) => {
                if (n === 0) return 'bg-emerald-600 text-black border-emerald-400/40 shadow-emerald-900/40';
                if (COLORS.red.includes(n)) return 'bg-red-600 text-white border-red-400/40 shadow-red-950/40';
                return 'bg-zinc-800 text-white border-zinc-700 shadow-black';
            };

            if (status === 'conectando') return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-black">
                    <div className="loading-ring"></div>
                    <p className="mt-8 text-[10px] font-black text-emerald-500 uppercase tracking-[0.5em] animate-pulse italic">Quantum Sync Active</p>
                </div>
            );

            return (
                <div className="min-h-screen p-4 lg:p-8 bg-[#030305] animate-in overflow-y-auto">
                    <div className="max-w-7xl mx-auto space-y-8">
                        
                        {/* HEADER DASHBOARD */}
                        <header className="glass p-6 rounded-[2.5rem] flex justify-between items-center shadow-2xl border-emerald-500/10">
                            <div className="flex items-center gap-6">
                                <div className="w-16 h-16 bg-emerald-600 rounded-3xl flex items-center justify-center shadow-lg shadow-emerald-950/40">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" className="text-white"><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2" /></svg>
                                </div>
                                <div className="text-left">
                                    <h1 className="text-xl font-black uppercase italic tracking-tighter text-white leading-none">Quantum <span className="text-emerald-500">Elite V5.4</span></h1>
                                    <div className="flex items-center gap-2 mt-2">
                                        <div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                                        <span className="text-[10px] text-zinc-500 font-bold uppercase tracking-widest italic">Base Cloud Sincronizada</span>
                                    </div>
                                </div>
                            </div>
                            <div className="text-right">
                                <p className="text-[10px] text-zinc-500 font-bold uppercase mb-1">Banca de Gestão</p>
                                <p className="text-2xl font-black text-emerald-500 italic font-mono leading-none tracking-tighter">R$ 100,00</p>
                            </div>
                        </header>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
                            
                            {/* COLUNA ESQUERDA: MONITOR E TECLADO */}
                            <div className="lg:col-span-8 space-y-8">
                                
                                {/* MONITOR CENTRAL - IA AUDITORIA */}
                                <div className={`relative min-h-[440px] p-10 rounded-[3.5rem] border-2 transition-all duration-700 flex flex-col items-center justify-center ${signal ? 'bg-emerald-600/5 border-emerald-500 shadow-[0_0_100px_-20px_rgba(16,185,129,0.2)]' : 'bg-zinc-900/20 border-zinc-800 shadow-inner opacity-60'}`}>
                                    {!signal ? (
                                        <div className="text-center space-y-12 w-full animate-in">
                                            <div className="relative">
                                                <div className="absolute inset-0 bg-emerald-500 blur-2xl opacity-10 animate-pulse"></div>
                                                <svg width="72" height="72" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1" className="text-emerald-500/20 mx-auto relative z-10">
                                                    <circle cx="12" cy="12" r="10" /><path d="m12 12 4 4" className="animate-pulse" />
                                                </svg>
                                            </div>
                                            <div className="space-y-6">
                                                <h2 className="text-[12px] font-black uppercase tracking-[0.6em] text-zinc-400 leading-relaxed text-center">ANALISANDO MESA<br/><span className="text-[10px] text-zinc-600 font-bold tracking-widest italic">Aguardando Convergência de Variância</span></h2>
                                                <div className="w-64 h-1.5 bg-zinc-800/50 mx-auto rounded-full overflow-hidden border border-zinc-800 shadow-inner">
                                                    <div className="h-full bg-emerald-500 transition-all duration-1000" style={{ width: `${Math.min(100, (history.length/5)*100)}%` }}></div>
                                                </div>
                                                <p className="text-[10px] text-zinc-500 italic uppercase font-black tracking-widest">Introduza 5 números para ativar o cérebro</p>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="w-full space-y-10 text-center animate-in">
                                            <div className="space-y-4">
                                                <div className="inline-flex items-center gap-3 px-10 py-3 bg-emerald-500 text-black rounded-full shadow-2xl">
                                                    <span className="text-[12px] font-black uppercase tracking-widest italic">ENTRADA CONFIRMADA</span>
                                                </div>
                                                <h2 className="text-5xl font-black text-white tracking-tighter uppercase italic leading-none">{signal.type}</h2>
                                            </div>

                                            <div className="space-y-6">
                                                <p className="text-[12px] font-bold text-zinc-400 uppercase tracking-widest italic">COBRIR PLENOS (PROG. FIBONACCI):</p>
                                                <div className="flex flex-wrap justify-center gap-4">
                                                    {signal.numbers.map((n, i) => (
                                                        <div key={i} className={`token shadow-2xl transition-transform hover:scale-110 ${getStyle(n)}`}>
                                                            {n}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>

                                            <div className="bg-black/80 p-8 rounded-[2.5rem] border border-white/5 text-left relative shadow-inner mx-auto max-w-2xl">
                                                <div className="flex items-center justify-between mb-5 border-b border-white/5 pb-4">
                                                    <div className="flex items-center gap-3 text-[12px] font-black text-emerald-500 uppercase tracking-widest">
                                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2" /></svg>
                                                        AUDITORIA IA QUANTUM
                                                    </div>
                                                    <span className="text-[10px] font-black text-zinc-600 uppercase bg-black px-4 py-2 rounded-full border border-zinc-900">Assertividade: {signal.confidence}%</span>
                                                </div>
                                                {isAiLoading ? (
                                                    <div className="flex flex-col items-center gap-4 py-4">
                                                        <div className="loading-ring !w-8 !h-8"></div>
                                                        <p className="text-[10px] text-emerald-500/50 animate-pulse font-black uppercase tracking-widest">Processando Permutações de Poisson...</p>
                                                    </div>
                                                ) : (
                                                    <p className="text-[12px] text-zinc-300 italic line-clamp-4 leading-relaxed font-medium text-left">
                                                        {aiFeedback || "Kernel Local em conformidade com o Ranking de Sucessão."}
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* TECLADO PROFISSIONAL - TAMANHO UNIFORME */}
                                <div className="glass p-10 rounded-[3.5rem] shadow-2xl border border-zinc-800/50">
                                    <div className="grid grid-cols-6 gap-4">
                                        <button onClick={() => addNumber(0)} className="col-span-12 h-16 bg-emerald-600 hover:bg-emerald-500 rounded-[1.5rem] font-black text-3xl border border-emerald-500/20 transition-all mb-4 btn-active shadow-lg shadow-emerald-950/40 text-black">0</button>
                                        {ORDERED_NUMBERS.map(n => (
                                            <button 
                                                key={n} 
                                                onClick={() => addNumber(n)} 
                                                className={`h-16 flex items-center justify-center font-black text-2xl rounded-[1.25rem] border-b-4 active:scale-90 transition-all text-white btn-active shadow-lg ${getStyle(n)}`}
                                            >
                                                {n}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* COLUNA DIREITA: RANKING E HISTÓRICO - LARGURA EQUILIBRADA */}
                            <div className="lg:col-span-4 space-y-8">
                                
                                {/* RANKING ORDENS DE SAÍDA - TAMANHO UNIFORME NÃO ENCOLHIDO */}
                                <div className="glass p-8 rounded-[3.5rem] shadow-xl min-h-[440px] flex flex-col border border-zinc-800/50">
                                    <div className="flex justify-between items-center mb-10 px-2">
                                        <h3 className="text-[13px] font-black uppercase text-zinc-300 tracking-widest flex items-center gap-3">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M7 11V7a5 5 0 0 1 10 0v4"/><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/></svg>
                                            ORDENS DE SAÍDA
                                        </h3>
                                        <span className="text-[9px] font-black text-zinc-600 bg-black px-3 py-1.5 rounded-full uppercase tracking-tighter shadow-inner">Pós Nº {history[0] ?? '?'}</span>
                                    </div>
                                    
                                    <div className="space-y-6 flex-1 overflow-y-auto custom-scrollbar pr-2">
                                        {transitionsRanking ? transitionsRanking.map((item, idx) => (
                                            <div key={idx} className="flex justify-between items-center bg-black/40 p-5 rounded-2xl border border-white/5 animate-in shadow-md transition-all group hover:border-emerald-500/20">
                                                <div className="flex items-center gap-6">
                                                    <div className={`token shadow-2xl transition-transform group-hover:scale-110 ${getStyle(item.num)}`}>
                                                        {item.num}
                                                    </div>
                                                    <div className="text-left space-y-1">
                                                        <span className="text-[10px] font-bold text-zinc-500 uppercase tracking-tighter leading-none italic">Frequência Alta</span>
                                                        <p className="text-[13px] font-black text-white uppercase tracking-widest leading-none">Ranking #{idx + 1}</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <span className="text-3xl font-black text-emerald-500 leading-none">{item.count}</span>
                                                    <p className="text-[9px] font-bold text-zinc-600 uppercase mt-1 text-right">Vezes</p>
                                                </div>
                                            </div>
                                        )) : (
                                            <div className="flex-1 flex flex-col items-center justify-center bg-black/20 p-10 rounded-[3rem] border border-dashed border-zinc-800 text-center opacity-40">
                                                <p className="text-[11px] text-zinc-600 italic uppercase font-black leading-relaxed tracking-widest text-center">
                                                    Mapeando Mesa...<br/>Sincronizando Tendências
                                                </p>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* HISTÓRICO RECENTE - TAMANHO PADRONIZADO FIXO */}
                                <div className="glass p-8 rounded-[3.5rem] shadow-xl h-[420px] flex flex-col border border-zinc-800/50">
                                    <h3 className="text-[13px] font-black uppercase text-zinc-500 tracking-widest mb-8 flex items-center gap-3">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/></svg>
                                        HISTÓRICO RECENTE
                                    </h3>
                                    <div className="flex-1 overflow-y-auto pr-3 custom-scrollbar space-y-5">
                                        {history.map((n, i) => (
                                            <div key={i} className="flex items-center justify-between p-4 rounded-2xl bg-white/5 border border-white/5 animate-in shadow-sm">
                                                <div className="flex items-center gap-6">
                                                    <div className={`token !w-12 !h-12 !text-xl !rounded-xl ${getStyle(n)}`}>
                                                        {n}
                                                    </div>
                                                    <span className="text-[12px] font-bold text-zinc-400 uppercase tracking-tighter">
                                                        {n === 0 ? 'Zero' : COLORS.red.includes(n) ? 'Vermelho' : 'Preto'}
                                                    </span>
                                                </div>
                                                <span className="text-[11px] font-mono text-zinc-700 font-bold italic text-right"># {history.length - i}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <footer className="space-y-6 pt-10 pb-20">
                            <p className="text-[11px] text-zinc-600 text-center uppercase font-black tracking-[0.4em] animate-pulse italic">
                                Dica: Só entre na mesa quando o bot emitir o alerta ENTRADA CONFIRMADA.
                            </p>
                            <div className="bg-red-950/10 border border-red-900/10 p-10 rounded-[3.5rem] text-center max-w-5xl mx-auto shadow-inner">
                                <p className="text-[11px] text-zinc-600 uppercase font-black tracking-widest leading-relaxed text-center">
                                    O Motor Elite Quantum V5.4 utiliza modelos estocásticos para identificar falhas de variância. Jogue com gestão rigorosa. Se perder no primeiro sinal, aceite o stop.
                                </p>
                            </div>
                        </footer>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
