import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, serverTimestamp } from 'firebase/firestore';

// --- CONFIGURAÇÃO AMBIENTE ---
const firebaseConfig = typeof __firebase_config !== 'undefined' 
  ? JSON.parse(__firebase_config) 
  : {
      apiKey: "AIzaSyCUcHQrnU-2312pAFiPzH_35SO3gQ6Wsd4",
      authDomain: "meubotroleta.firebaseapp.com",
      projectId: "meubotroleta",
      storageBucket: "meubotroleta.firebasestorage.app",
      messagingSenderId: "22051928464",
      appId: "1:22051928464:web:b58b2604a9b677942adb15"
    };

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'roulette-pro-v5';

// --- GEOMETRIA DA RODA BRASILEIRA ---
const WHEEL_ORDER = [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26];

const COLORS = {
  red: [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36],
  black: [2, 4, 6, 8, 10, 11, 13, 15, 17, 20, 22, 24, 26, 28, 29, 31, 33, 35],
  green: [0]
};

// --- COMPONENTES VISUAIS ---
const IconRadar = () => (
  <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className="text-emerald-500/40">
    <circle cx="12" cy="12" r="10" />
    <circle cx="12" cy="12" r="6" />
    <path d="M12 2v2M12 20v2M2 12h2M20 12h2" />
    <path d="m12 12 4 4" className="animate-pulse" />
  </svg>
);

const App = () => {
  const [user, setUser] = useState(null);
  const [history, setHistory] = useState([]);
  const [signal, setSignal] = useState(null);
  const [analysisProgress, setAnalysisProgress] = useState(0);
  const [bankroll] = useState(100);

  // 1. Autenticação (REGRA 3)
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Erro na autenticação:", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // 2. Lógica de Sinais
  const runAdvancedLogic = useCallback((nums) => {
    if (nums.length < 5) {
      setAnalysisProgress((nums.length / 5) * 100);
      setSignal(null);
      return;
    }

    setAnalysisProgress(100);
    const last = nums[0];
    
    // Inversão de Cor (4 seguidos)
    const colorStreak = nums.slice(0, 4).map(n => COLORS.red.includes(n) ? 'R' : 'B');
    if (colorStreak.length === 4 && colorStreak.every(c => c === colorStreak[0])) {
        const oppositeZone = colorStreak[0] === 'R' ? [2, 4, 6, 11, 13, 17, 20, 22] : [1, 3, 5, 9, 12, 14, 16, 18];
        return setSignal({
            type: "INVERSÃO DE COR",
            numbers: oppositeZone,
            confidence: 88,
            pivot: oppositeZone[0]
        });
    }

    // Repetição de Vizinhos (Raio de 3)
    const idx = WHEEL_ORDER.indexOf(last);
    if (idx !== -1) {
        const neighbors = [];
        for(let i=-3; i<=3; i++) neighbors.push(WHEEL_ORDER[(idx + i + 37) % 37]);
        const repetitions = nums.slice(1, 6).filter(n => neighbors.includes(n));
        if (repetitions.length >= 2) {
            return setSignal({
                type: "ZONA DE IMPACTO",
                numbers: neighbors,
                confidence: 94,
                pivot: last
            });
        }
    }

    setSignal(null);
  }, []);

  // 3. Monitorização Firestore (REGRA 1 e 2)
  useEffect(() => {
    if (!user) return;
    
    const spinsCollection = collection(db, 'artifacts', appId, 'users', user.uid, 'spins');
    const q = query(spinsCollection); // Consulta simples (REGRA 2)

    const unsubscribe = onSnapshot(q, (snap) => {
      const data = snap.docs
        .map(d => ({ ...d.data(), id: d.id }))
        .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)) // Ordenação em memória (REGRA 2)
        .map(d => parseInt(d.number))
        .filter(n => !isNaN(n));
      
      setHistory(data.slice(0, 20));
      runAdvancedLogic(data);
    }, (err) => {
      console.error("Erro no Snapshot:", err);
    });

    return () => unsubscribe();
  }, [user, runAdvancedLogic]);

  // Gravação de Dados
  const addNumber = async (n) => {
    if (!user) return;
    try {
      const spinsCollection = collection(db, 'artifacts', appId, 'users', user.uid, 'spins');
      await addDoc(spinsCollection, {
        number: parseInt(n),
        timestamp: serverTimestamp()
      });
    } catch (e) {
      console.error("Erro ao gravar número:", e);
    }
  };

  if (!user) return (
    <div className="min-h-screen bg-black flex items-center justify-center">
      <div className="text-center space-y-4">
        <div className="w-10 h-10 border-2 border-emerald-500/20 border-t-emerald-500 rounded-full animate-spin mx-auto"></div>
        <p className="text-[10px] font-black text-emerald-500 uppercase tracking-widest animate-pulse">Autenticando Kernel V5.2</p>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-[#050507] text-zinc-100 p-4 font-sans select-none">
      <div className="max-w-md mx-auto space-y-6">
        
        {/* CABEÇALHO */}
        <div className="bg-zinc-900/40 p-5 rounded-[2rem] border border-zinc-800 flex justify-between items-center backdrop-blur-md">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-emerald-600 rounded-2xl flex items-center justify-center shadow-lg shadow-emerald-900/20">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" /></svg>
            </div>
            <div>
              <h1 className="text-xs font-black uppercase tracking-tight">Quantum <span className="text-emerald-500 italic">V5.2 Pro</span></h1>
              <p className="text-[8px] text-zinc-500 font-bold uppercase tracking-widest mt-0.5">ID: {user.uid.substring(0,8)}...</p>
            </div>
          </div>
          <div className="text-right">
            <p className="text-[8px] text-zinc-500 font-bold uppercase">Banca</p>
            <p className="text-xs font-black text-emerald-500 tracking-tighter">R$ {bankroll.toFixed(2)}</p>
          </div>
        </div>

        {/* MONITOR PRINCIPAL */}
        <div className={`relative min-h-[350px] p-8 rounded-[2.5rem] border-2 transition-all duration-700 flex flex-col items-center justify-center ${signal ? 'bg-emerald-600/10 border-emerald-500 shadow-[0_0_80px_-20px_rgba(16,185,129,0.3)]' : 'bg-zinc-900/30 border-zinc-800'}`}>
          
          {!signal ? (
            <div className="text-center space-y-8 animate-in">
              <IconRadar />
              <div className="space-y-4">
                <div className="space-y-1">
                  <h2 className="text-[11px] font-black uppercase tracking-[0.4em] text-zinc-400">Analisando Mesa</h2>
                  <p className="text-[9px] text-zinc-600 font-bold uppercase">Aguardando Padrão de Entrada</p>
                </div>
                
                <div className="w-48 h-1.5 bg-zinc-800/50 mx-auto rounded-full overflow-hidden border border-zinc-800">
                  <div 
                    className="h-full bg-emerald-500 transition-all duration-1000 ease-out"
                    style={{ width: `${analysisProgress}%` }}
                  ></div>
                </div>
                
                <p className="text-[9px] text-zinc-500 px-6 leading-relaxed">
                  {history.length < 5 
                    ? `Insira mais ${5 - history.length} números para iniciar a leitura.` 
                    : "Mesa calibrada. Aguardando gatilho de alta assertividade..."}
                </p>
              </div>
            </div>
          ) : (
            <div className="w-full space-y-8 animate-in text-center">
              <div className="space-y-2">
                <div className="inline-flex items-center gap-2 px-4 py-1.5 bg-emerald-500 text-black rounded-full shadow-lg shadow-emerald-500/20">
                  <span className="w-1.5 h-1.5 bg-black rounded-full animate-ping"></span>
                  <span className="text-[10px] font-black uppercase tracking-widest">Entrada Confirmada</span>
                </div>
                <h2 className="text-3xl font-black text-white tracking-tighter uppercase italic">{signal.type}</h2>
              </div>

              <div className="space-y-4">
                <p className="text-[10px] font-bold text-zinc-400 uppercase tracking-widest">Cobrir Plenos:</p>
                <div className="grid grid-cols-4 gap-2">
                  {signal.numbers.map((n, i) => (
                    <div key={i} className={`h-12 rounded-xl flex flex-col items-center justify-center border-2 border-white/5 shadow-xl ${COLORS.red.includes(n) ? 'bg-red-600' : n === 0 ? 'bg-emerald-600' : 'bg-zinc-950'}`}>
                      <span className="text-lg font-black text-white">{n}</span>
                      <span className="text-[7px] opacity-40 font-bold">R$ 1.00</span>
                    </div>
                  ))}
                </div>
              </div>

              <div className="grid grid-cols-2 gap-3 pt-4 border-t border-white/5">
                <div className="bg-black/40 p-3 rounded-2xl border border-white/5">
                  <p className="text-[8px] text-zinc-500 font-bold uppercase mb-1">Confiança</p>
                  <p className="text-sm font-black text-emerald-500">{signal.confidence}%</p>
                </div>
                <div className="bg-black/40 p-3 rounded-2xl border border-white/5">
                  <p className="text-[8px] text-zinc-500 font-bold uppercase mb-1">Pivot</p>
                  <p className="text-sm font-black text-white uppercase">Nº {signal.pivot}</p>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* TECLADO DE INPUT */}
        <div className="bg-zinc-900/50 p-6 rounded-[2.5rem] border border-zinc-800 shadow-2xl">
          <div className="flex justify-between items-center mb-5 px-1">
             <h3 className="text-[10px] font-black uppercase text-zinc-500 tracking-widest flex items-center gap-2">
               <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M11 2L3 14h9l-1 8 8-12h-9l1-8z"/></svg>
               Registrar Spin
             </h3>
             <span className="text-[8px] font-black text-emerald-500/50 uppercase tracking-widest">Brasileira Live</span>
          </div>
          <div className="grid grid-cols-6 gap-2">
            <button onClick={() => addNumber(0)} className="col-span-6 h-12 bg-emerald-600/10 text-emerald-500 hover:bg-emerald-600 hover:text-white rounded-xl font-black text-lg border border-emerald-500/20 transition-all mb-2">0</button>
            {[3, 6, 9, 12, 15, 18, 2, 5, 8, 11, 14, 17, 1, 4, 7, 10, 13, 16, 21, 24, 27, 30, 33, 36, 20, 23, 26, 29, 32, 35, 19, 22, 25, 28, 31, 34].map(n => (
              <button 
                key={n} 
                onClick={() => addNumber(n)} 
                className={`h-10 flex items-center justify-center font-black text-sm rounded-lg border-b-2 active:scale-90 transition-all text-white ${COLORS.red.includes(n) ? 'bg-red-600/80 border-red-900' : 'bg-zinc-800 border-black'}`}
              >
                {n}
              </button>
            ))}
          </div>
        </div>

        {/* HISTÓRICO */}
        <div className="bg-zinc-900/20 p-5 rounded-[2rem] border border-zinc-800/50">
          <h3 className="text-[9px] font-black uppercase text-zinc-500 tracking-widest mb-4 px-1">Sequência Analisada</h3>
          <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
            {history.map((n, i) => (
              <div key={i} className={`w-9 h-9 shrink-0 rounded-xl flex items-center justify-center font-black text-xs border border-white/5 animate-in ${COLORS.red.includes(n) ? 'bg-red-600 text-white' : n === 0 ? 'bg-emerald-600 text-black' : 'bg-zinc-800 text-white'}`}>
                {n}
              </div>
            ))}
            {history.length === 0 && <p className="text-[9px] text-zinc-700 font-bold uppercase p-2">Sem Telemetria</p>}
          </div>
        </div>
      </div>

      <style>{`
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .animate-in { animation: fade-in 0.5s ease-out forwards; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      `}</style>
    </div>
  );
};

export default App;
