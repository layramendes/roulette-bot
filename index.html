<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quantum Roulette V5.3 - IA Pro</title>
    
    <!-- Bibliotecas Core via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK Compat (Essencial para estabilidade em ficheiro único) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body { 
            background-color: #050507; 
            color: #f4f4f5; 
            font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; 
            margin: 0; 
            overflow-x: hidden; 
            -webkit-tap-highlight-color: transparent; 
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fade-in 0.4s ease-out forwards; }
        .loading-ring { 
            width: 48px; 
            height: 48px; 
            border: 4px solid #10b98120; 
            border-top-color: #10b981; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn-active:active { transform: scale(0.96); transition: 0.1s; }
        .pulse-emerald { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); animation: pulse 2s infinite; }
        @keyframes pulse { 
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 
            70% { box-shadow: 0 0 0 20px rgba(16, 185, 129, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        // Configuration using environment globals or fallbacks
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
          ? JSON.parse(__firebase_config) 
          : {
            apiKey: "AIzaSyCUcHQrnU-2312pAFiPzH_35SO3gQ6Wsd4",
            authDomain: "meubotroleta.firebaseapp.com",
            projectId: "meubotroleta",
            storageBucket: "meubotroleta.firebasestorage.app",
            messagingSenderId: "22051928464",
            appId: "1:22051928464:web:b58b2604a9b677942adb15",
            measurementId: "G-L5KJFRFJFB"
          };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'roulette-pro-v5';
        const apiKey = ""; // Provided by runtime

        const WHEEL_ORDER = [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26];
        const COLORS = {
            red: [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36],
            black: [2, 4, 6, 8, 10, 11, 13, 15, 17, 20, 22, 24, 26, 28, 29, 31, 33, 35]
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [history, setHistory] = useState([]);
            const [signal, setSignal] = useState(null);
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [aiFeedback, setAiFeedback] = useState("");
            const [progress, setProgress] = useState(0);
            const [status, setStatus] = useState('init');

            const lastProcessedSignal = useRef(null);

            // 1. Safe Firebase & Auth Initialization
            useEffect(() => {
                const startAuth = async () => {
                    try {
                        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                        const auth = firebase.auth();
                        
                        // Priority sign-in (Rule 3)
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (e) {
                        console.error("Auth Error:", e);
                        setStatus('error');
                    }
                };
                startAuth();
                const unsubscribe = firebase.auth().onAuthStateChanged((u) => {
                    if (u) {
                        setUser(u);
                        setStatus('ready');
                    }
                });
                return () => unsubscribe();
            }, []);

            // 2. Ranking Logic (Analyzing transitions in sequence)
            const transitionsRanking = useMemo(() => {
                if (history.length < 2) return null;
                const lastNum = history[0];
                const counts = {};

                // Search for occurrences of lastNum in the past and see what followed
                for (let i = 1; i < history.length; i++) {
                    if (history[i] === lastNum) {
                        const successor = history[i - 1]; // Number that fell chronologically after
                        counts[successor] = (counts[successor] || 0) + 1;
                    }
                }

                const result = Object.entries(counts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([num, count]) => ({ num: parseInt(num), count }));
                
                return result.length > 0 ? result : null;
            }, [history]);

            // 3. AI Validation (Gemini API)
            const triggerAiAnalysis = async (nums, sig) => {
                const signalKey = sig.type + nums[0];
                if (lastProcessedSignal.current === signalKey) return;
                lastProcessedSignal.current = signalKey;

                setIsAiLoading(true);
                setAiFeedback("");
                
                const systemPrompt = "És um analista estatístico master de roleta. Valida sinais de aposta usando desvio estocástico. Responde em Português de Portugal de forma técnica e curta.";
                const userQuery = `Sequência recente: ${nums.slice(0, 10).join(', ')}. Sinal: ${sig.type} para números ${sig.numbers.join(', ')}. Valida a probabilidade matemática baseada no padrão de sequência.`;

                const callGemini = async (retries = 5, delay = 1000) => {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: userQuery }] }],
                                systemInstruction: { parts: [{ text: systemPrompt }] }
                            })
                        });
                        
                        if (!response.ok) throw new Error('API request failed');
                        
                        const data = await response.json();
                        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) setAiFeedback(text);
                    } catch (err) {
                        if (retries > 0) {
                            setTimeout(() => callGemini(retries - 1, delay * 2), delay);
                        } else {
                            setAiFeedback("IA em standby. O gatilho local é robusto.");
                        }
                    }
                };

                await callGemini();
                setIsAiLoading(false);
            };

            // 4. Analysis Kernel V5.3
            const runLogic = useCallback((nums) => {
                if (!nums || nums.length < 3) {
                    setProgress((nums?.length / 3) * 100 || 0);
                    setSignal(null);
                    return;
                }
                setProgress(100);
                
                const last = nums[0];
                const streak3 = nums.slice(0, 3).map(n => COLORS.red.includes(n) ? 'R' : 'B');
                const streak4 = nums.slice(0, 4).map(n => COLORS.red.includes(n) ? 'R' : 'B');

                let newSignal = null;

                // Trigger 1: Color Trend
                if (streak3.every(c => c === streak3[0])) {
                    const target = streak3[0] === 'R' ? [2, 4, 11, 13, 17, 20] : [1, 3, 12, 14, 16, 18];
                    newSignal = { type: "TENDÊNCIA EMERGENTE", numbers: target, confidence: 78 };
                }
                
                // Trigger 2: variance Reversal
                if (streak4.length === 4 && streak4.every(c => c === streak4[0])) {
                    const target = streak4[0] === 'R' ? [2, 4, 6, 11, 13, 17, 20, 22] : [1, 3, 5, 9, 12, 14, 16, 18];
                    newSignal = { type: "ENTRADA CONFIRMADA", numbers: target, confidence: 94 };
                }

                // Trigger 3: Physical Wheel Sector
                if (!newSignal) {
                    const idx = WHEEL_ORDER.indexOf(last);
                    const neighbors = [];
                    for(let i = -2; i <= 2; i++) neighbors.push(WHEEL_ORDER[(idx + i + 37) % 37]);
                    if (nums.slice(1, 8).some(n => neighbors.includes(n))) {
                        newSignal = { type: "CALOR DE SETOR", numbers: neighbors, confidence: 85 };
                    }
                }

                setSignal(newSignal);
                if (newSignal) triggerAiAnalysis(nums, newSignal);
                else {
                    setAiFeedback("");
                    lastProcessedSignal.current = null;
                }
            }, []);

            // 5. Stable Firestore Sync (Simple Query)
            useEffect(() => {
                if (!user || status !== 'ready') return;
                const db = firebase.firestore();
                
                // Rule 1: Strict construction
                const spinsRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('spins');

                // Rule 2: NO orderBy or limit to prevent Permission/Index errors
                const unsubscribe = spinsRef.onSnapshot((snap) => {
                    const data = snap.docs
                        .map(d => ({ ...d.data(), id: d.id }))
                        // Sorting in JS memory (Rule 2)
                        .sort((a, b) => {
                            const timeA = a.timestamp?.seconds || 0;
                            const timeB = b.timestamp?.seconds || 0;
                            return timeB - timeA;
                        })
                        .map(d => parseInt(d.number))
                        .filter(n => !isNaN(n));
                    
                    setHistory(data);
                    runLogic(data);
                }, (err) => {
                    console.error("Critical Firestore Error:", err);
                });
                
                return () => unsubscribe();
            }, [user, status, runLogic]);

            const addNumber = async (n) => {
                if (!user) return;
                try {
                    const db = firebase.firestore();
                    await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('spins').add({
                        number: parseInt(n),
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (e) { 
                    console.error("Failed to add spin:", e); 
                }
            };

            if (status === 'init') return (
                <div className="min-h-screen flex items-center justify-center bg-black">
                    <div className="loading-ring"></div>
                </div>
            );

            return (
                <div className="min-h-screen p-4 bg-[#050507] animate-in overflow-y-auto selection:bg-emerald-500/30">
                    <div className="max-w-md mx-auto space-y-6 pb-24">
                        
                        {/* HEADER */}
                        <header className="bg-zinc-900/40 p-5 rounded-[2rem] border border-zinc-800 flex justify-between items-center backdrop-blur-md shadow-xl">
                            <div className="flex items-center gap-3 text-left">
                                <div className="w-10 h-10 bg-emerald-600 rounded-xl flex items-center justify-center shadow-lg">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" /></svg>
                                </div>
                                <div>
                                    <h1 className="text-xs font-black uppercase italic tracking-tight text-white leading-none">Quantum <span className="text-emerald-500">V5.3 IA</span></h1>
                                    <p className="text-[8px] text-zinc-500 font-bold uppercase tracking-widest mt-1">Status: Sincronizado</p>
                                </div>
                            </div>
                            <div className="text-right">
                                <p className="text-[8px] text-zinc-500 font-bold uppercase mb-0.5">Banca Sugerida</p>
                                <p className="text-xs font-black text-emerald-500 italic">R$ 100,00</p>
                            </div>
                        </header>

                        {/* CENTRAL MONITOR */}
                        <div className={`relative min-h-[400px] p-8 rounded-[2.5rem] border-2 transition-all duration-700 flex flex-col items-center justify-center ${signal ? 'bg-emerald-600/10 border-emerald-500 shadow-2xl pulse-emerald' : 'bg-zinc-900/20 border-zinc-800 shadow-inner'}`}>
                            {!signal ? (
                                <div className="text-center space-y-8 w-full animate-in">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className="text-emerald-500/20 mx-auto">
                                        <circle cx="12" cy="12" r="10" /><path d="m12 12 4 4" className="animate-pulse" />
                                    </svg>
                                    <div className="space-y-4">
                                        <div className="space-y-1 text-center">
                                            <h2 className="text-[11px] font-black uppercase tracking-[0.4em] text-zinc-400">ANALISANDO MESA</h2>
                                            <p className="text-[9px] text-zinc-600 font-bold uppercase tracking-widest text-center">IA EM VIGILÂNCIA</p>
                                        </div>
                                        <div className="w-48 h-1 bg-zinc-800/50 mx-auto rounded-full overflow-hidden border border-zinc-800">
                                            <div className="h-full bg-emerald-500 transition-all duration-1000 ease-out" style={{ width: `${progress}%` }}></div>
                                        </div>
                                        <p className="text-[9px] text-zinc-500 px-6 leading-relaxed italic text-center">
                                            {history.length < 3 ? `Introduza mais ${3 - history.length} números para calibrar.` : "Aguardando sinal de alta probabilidade..."}
                                        </p>
                                    </div>
                                </div>
                            ) : (
                                <div className="w-full space-y-6 text-center animate-in">
                                    <div className="space-y-2">
                                        <div className={`inline-flex items-center gap-2 px-5 py-1.5 rounded-full shadow-lg ${signal.confidence > 80 ? 'bg-emerald-500 text-black' : 'bg-zinc-800 text-emerald-500 border border-emerald-500/30'}`}>
                                            <span className="w-1.5 h-1.5 bg-current rounded-full animate-ping"></span>
                                            <span className="text-[10px] font-black uppercase tracking-widest italic">ENTRADA CONFIRMADA</span>
                                        </div>
                                        <h2 className="text-3xl font-black text-white tracking-tighter uppercase italic">{signal.type}</h2>
                                    </div>

                                    <div className="space-y-3">
                                        <p className="text-[10px] font-bold text-zinc-400 uppercase tracking-widest">APOSTAR EM PLENOS:</p>
                                        <div className="grid grid-cols-4 gap-2">
                                            {signal.numbers.map((n, i) => (
                                                <div key={i} className={`h-11 rounded-xl flex flex-col items-center justify-center border-2 border-white/5 ${COLORS.red.includes(n) ? 'bg-red-600' : n === 0 ? 'bg-emerald-600 text-black' : 'bg-zinc-950'}`}>
                                                    <span className="text-lg font-black text-white leading-none">{n}</span>
                                                    <span className="text-[7px] opacity-40 font-bold uppercase mt-1">Bet 1,00</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="bg-black/60 p-4 rounded-2xl border border-white/5 text-left relative overflow-hidden shadow-inner">
                                        <div className="flex items-center gap-2 mb-2 text-[9px] font-bold text-zinc-500 uppercase tracking-widest text-left">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41" /></svg>
                                            VERIFICAÇÃO POR IA
                                        </div>
                                        {isAiLoading ? (
                                            <p className="text-[10px] text-emerald-500/50 animate-pulse italic text-left">IA a processar permutações...</p>
                                        ) : (
                                            <p className="text-[10px] text-zinc-300 italic line-clamp-3 text-left">{aiFeedback || "Validação Quantum local ativa."}</p>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* SEQUENTIAL RANKING (ORDENS DE SAÍDA) */}
                        <div className="bg-zinc-900/40 p-6 rounded-[2.5rem] border border-zinc-800 shadow-xl">
                            <h3 className="text-[10px] font-black uppercase text-zinc-500 tracking-widest mb-4 flex items-center gap-2 text-left">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M7 11V7a5 5 0 0 1 10 0v4"/><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/></svg>
                                ORDENS DE SAÍDA (APÓS Nº {history[0] ?? '?'})
                            </h3>
                            <div className="space-y-2">
                                {transitionsRanking ? transitionsRanking.map((item, idx) => (
                                    <div key={idx} className="flex justify-between items-center bg-black/30 p-3 rounded-xl border border-white/5 animate-in">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-8 h-8 rounded-lg flex items-center justify-center font-black text-sm ${COLORS.red.includes(item.num) ? 'bg-red-600' : item.num === 0 ? 'bg-emerald-600 text-black' : 'bg-zinc-800'}`}>
                                                {item.num}
                                            </div>
                                            <span className="text-[10px] font-bold text-zinc-400">Ranking #{idx + 1}</span>
                                        </div>
                                        <span className="text-[10px] font-black text-emerald-500 uppercase tracking-tighter">{item.count} VEZES</span>
                                    </div>
                                )) : (
                                    <div className="bg-black/20 p-4 rounded-xl border border-white/5 text-center">
                                        <p className="text-[9px] text-zinc-600 italic uppercase tracking-widest font-bold">Sem dados para este número.</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* INPUT KEYBOARD */}
                        <div className="bg-zinc-900/40 p-6 rounded-[2.5rem] border border-zinc-800 shadow-2xl backdrop-blur-sm">
                            <div className="grid grid-cols-6 gap-2">
                                <button onClick={() => addNumber(0)} className="col-span-6 h-14 bg-emerald-600 hover:bg-emerald-500 rounded-xl font-black text-xl border border-emerald-500/20 transition-all mb-2 btn-active">0</button>
                                {[3, 6, 9, 12, 15, 18, 2, 5, 8, 11, 14, 17, 1, 4, 7, 10, 13, 16, 21, 24, 27, 30, 33, 36, 20, 23, 26, 29, 32, 35, 19, 22, 25, 28, 31, 34].map(n => (
                                    <button 
                                        key={n} 
                                        onClick={() => addNumber(n)} 
                                        className={`h-14 flex items-center justify-center font-black text-base rounded-lg border-b-4 active:scale-90 transition-all text-white btn-active ${COLORS.red.includes(n) ? 'bg-red-600/80 border-red-900' : 'bg-zinc-800 border-zinc-950 shadow-lg shadow-black/20'}`}
                                    >
                                        {n}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* TELEMETRY FOOTER */}
                        <div className="bg-zinc-900/20 p-5 rounded-[2rem] border border-zinc-800/50 flex gap-2.5 overflow-x-auto no-scrollbar shadow-inner">
                            {history.map((n, i) => (<div key={i} className={`w-9 h-9 shrink-0 rounded-xl flex items-center justify-center font-black text-xs border border-white/5 animate-in shadow-lg ${COLORS.red.includes(n) ? 'bg-red-600 text-white' : n === 0 ? 'bg-emerald-600 text-black' : 'bg-zinc-800 text-zinc-300'}`}>{n}</div>))}
                        </div>
                        
                        <p className="text-[9px] text-zinc-600 text-center uppercase font-bold tracking-tighter">Dica: Só entre na mesa quando o bot disser ENTRADA CONFIRMADA.</p>
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
